## 概述

<img src="https://img.xiajibagao.top/image-20230221133602215.png" alt="image-20230221133602215" style="zoom:33%;" />

操作执行器 `BeanOperationExecutor` 是完成填充操作的核心组件，它决定了以何种方式使用对应处理器完成填充和装配操作。当我们调用 `execute` 方法后，它将完成四个步骤：

1. 接受待处理对象和对应的操作配置 `BeanOperations`；
2. 执行拆卸操作，将所有需要处理的对象平铺；
3. 按对象中各个 `key` 字段对应的操作，将对象和对应装配操作封装为执行对象 `Execution`；
4. 最终按特定的顺序将执行对象 `Execution` 分发给操作处理器 `OperationHandler` 完成操作；

操作执行器决定的各项操作的**执行顺序**，与对**数据源的访问次数**，是影响**执行效率**的关键组件之一。

## 4.3.1.可选实现

操作执行器有三种实现，用户可以根据需求自己选择：

- `DisorderedBeanOperationExecutor`：同步无序操作执行器，默认使用的操作执行器；
- `OrderedBeanOperationExecutor`：同步有序操作执行器，支持按顺序完成装配操作，但是相对无序执行器在特定情况性能有所影响；
- `AsyncBeanOperationExecutor`：异步操作执行器，默认不注册到 Spring 容器，需要用户自己注册；

以下是它们的异同点：

| 执行器                          | 是否按顺序执行 | 一次填充相同容器访问次数 | 是否异步 | 是否默认启用 |
| ------------------------------- | -------------- | ------------------------ | -------- | ------------ |
| AsyncBeanOperationExecutor      | ×              | n                        | √        | ×            |
| DisorderedBeanOperationExecutor | ×              | 1                        | ×        | √            |
| OrderedBeanOperationExecutor    | √              | n                        | ×        | √            |

其中，一次填充相同容器访问次数，是指当执行填充时，如果在一组填充中同时有 n 个操作都指定了相同的数据源容器，那么在本次填充中该数据源容器会被访问几次。

由于执行器按容器分组批量执行操作会打乱操作间原有顺序，因此目前批量提交与执行顺序不可兼得。

:::tip

在 spring 环境中，异步执行器 `AsyncBeanOperationExecutor` 默认是不注册的，要使用的话用户需要自己在 spring 上下文中配置。

:::

## 4.3.2.使用

**在手动填充时使用**

当手动填充时，可通过 `OperateTemplate` 的指定重载方法设置本次填充操作使用的操作执行器：

~~~java
// 从 spring 上下文中获取 OperateTemplate 和 DisorderedBeanOperationExecutor
OperateTemplate operateTemplate = SpringUtil.get(OperateTemplate.class); 
BeanOperationExecutor executor = SpringUtil.get(DisorderedBeanOperationExecutor.class);
operateTemplate.execute(fooList, executor, op -> true);
~~~

**在自动填充时使用**

当自动填充时，可以在 `@AutoOperate` 注解指操作执行器：

~~~java
// 填充返回值
@AutoOperate(type = Foo.class, executor = DisorderedBeanOperationExecutor.class)
public List<Foo> getFooList() {
    // do nothing
}

// 填充参数
@ArgAutoOperate(
    @AutoOperate(value = "foos", type = Foo.class, executor = DisorderedBeanOperationExecutor.class)
)
public void setFooList(List<Foo> foos) {
    // do nothing
}
~~~

