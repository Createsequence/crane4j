### 5.5.1.实现原理

目前 `crane4j` 支持通过 `@Assemble` 、`@Disassemble` 与 `@AssembleMp` 三种注解配置操作，虽然它们用起来有点像，不过实际上底层的实现是完全不同的。

根据前文，我们知道 `crane4j` 通过 `BeanOperationParser` 将 `AnnotatedElement` 中的各项注解配置转为最终需要的配置对象 `BeanOperations`，实际上不同注解配置的解析过程是由注册到 `Parser` 中的一批注解配置解析器 `OperationAssembleResolver` 共同完成的。

参照下图，我们可以理解每一个 `OperationAssembleResolver` 都对应一套注解解析规则，当我们向 `Parser` 输入一个需要解析的 `AnnotatedElement` 时，`Parser` 会为其创建一个 `BeanOperations` 配置对象，并像驱动流水线上的工件一样驱动它在解析器链上流转，每个解析器都根据自己的规则去解析 `AnnotatedElement` 中的配置，根据配置元数据去生成/调整 `BeanOperations` 中的操作对象，这是一套非常简单的责任链模式。

![image-20230405210611341](https://img.xiajibagao.top/image-20230405210611341.png)

### 5.5.2.自定义解析器

基于上述原理，也不难猜到目前的三套注解规则都有对应解析器：

- `AssembleAnnotationResolver` ：用于解析 `@Assemble` 注解生成装配操作；
- `DisassembleAnnotationResolver`：用于解析 `@Disassemble` 注解生成拆卸操作；
- `AssembleMpAnnotationResolver` ：用于解析 `@AssembleMp` 注解，生成以 MP 查询方法作为数据源的装配操作；

如果用户希望像支持可以支持自定义注解（或者我更喜欢叫它配置规则），则可以实现 `BeanOperationsResolver` 接口创建一个自定义解析器。

在 spring 环境中，仅需将自定义解析器交给 spring 管理即可，项目启动后会自动注册到 `Parser` 中，若在非 spring 环境中，也可以获取 `TypeHierarchyBeanOperationParser` 后调用 `addBeanOperationsResolver` 方法手动注册。

